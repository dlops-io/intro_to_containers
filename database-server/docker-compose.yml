version: "3.8"
services:
    # we have two services here, itcdb-client and itcdb-server
    # this client depends on the server
    itcdb-client:
        # source: https://github.com/amacneil/dbmate#postgresql
        # Dbmate is a database migration tool, to keep your database schema in sync across multiple developers and your production servers
        # keeps track of migrations, and runs it in an order; the power of dbmate is to manage migrations of the script; Shivas uses DataGrip to manage; “dbmate rollback” removes stuff; “dbmate up” creates the table; When we run this “sh ./docker-shell.sh”, I can get the same database setup as Shivas on his end
        image: amacneil/dbmate
        container_name: itcdb-client
        entrypoint: /bin/sh
        depends_on:
            - itcdb-server
        # source: https://docs.docker.com/storage/volumes/
        # Volumes are the preferred mechanism for persisting data generated by and used by Docker containers. While bind mounts are dependent on the directory structure and OS of the host machine, volumes are completely managed by Docker
        volumes:
            - ./db:/db
        environment: 
            DATABASE_URL: "postgres://itc:awesome@itcdb-server:5436/itcdb?sslmode=disable"
    itcdb-server:
        # The database is for the metadata (e.g. when a model predicts, keep track of the prediction results)
        image: postgres
        container_name: itcdb-server
        volumes:
            - ./docker-volumes/postgres:/var/lib/postgresql/data
        ports:
            - 5436:5436
        environment:
            POSTGRES_USER: itc
            POSTGRES_PASSWORD: awesome
            POSTGRES_DB: itcdb
        command: -p 5436
networks:
    default:
        name: itcnetwork
